#include <M5Unified.h>

#include "communication/bleManager.h"
#include "communication/constants.h"
#include "ui/uiManager.h"

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////// Function declaration /////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
//////////////////////////// Constants and Global Variables ///////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////// Setup and Loop ///////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////

void setup()
{
  // initialize Serial for debugging
  Serial.begin(115200);

  // IMPORTANT: Wait for Serial to be ready (especially with USB CDC)
  unsigned long startTime = millis();
  while (!Serial && (millis() - startTime < 5000))
  {
    delay(10); // Wait up to 5 seconds for Serial
  }
  delay(500); // Extra delay to ensure stability

  auto cfg = M5.config();
  // Initialize M5Stack CoreS3
  M5.begin(cfg);

  M5.Display.setRotation(1); // Landscape mode
  M5.Display.setTextSize(2);
  M5.Display.setTextColor(TEXT_COLOR);
  M5.Display.fillScreen(BG_COLOR);

  ///////////////////////////////////////////////////////
  ///////////////////////////////////////////////////////

  BLEManager::init();
  uiSetup();
}

void loop()
{
  // BLEManager::update();
  uiLoop();
}

///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////// Functions /////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
